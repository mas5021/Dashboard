<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agricultural Climate Dashboard</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- For map support -->
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 2rem; 
      background: #f8f9fa; 
    }
    h1 { text-align: center; }
    .dashboard { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr); 
      gap: 20px; 
      margin-bottom: 20px;
    }
    .viz { 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .tooltip { 
      position: absolute; 
      padding: 10px; 
      background: rgba(0,0,0,0.8); 
      color: white; 
      border-radius: 5px; 
      pointer-events: none;
      font-size: 12px;
    }
    .brush { fill-opacity: 0.2; stroke: #666; }
  </style>
</head>
<body>
  <h1>US Agricultural Climate Dashboard</h1>
  <div class="dashboard">
    <div class="viz" id="scatterplot"></div>
    <div class="viz" id="timeline"></div>
    <div class="viz" id="map"></div>
  </div>
  <div id="tooltip" class="tooltip" style="opacity:0;"></div>
  
  <script>
    // Data sources: crop and COâ‚‚ from actual URLs; temperature dummy data is provided inline.
    const DATA_URLS = {
      crop: 'https://gist.githubusercontent.com/mystrycodes/3d3cf36c88a4f23a187cb4e12a835e10/raw/CropProduction.csv',
      co2: 'https://gist.githubusercontent.com/mystrycodes/f3e133db6c35f1f7180296e872441fe4/raw/Co2emmission.csv',
      // Dummy temperature CSV (for example purposes)
      temp: 'data:text/csv,year,temp\n1990,15\n1991,15.2\n1992,15.3\n1993,15.4\n1994,15.5\n1995,15.6\n1996,15.7\n1997,15.8\n1998,15.9\n1999,16\n2000,16.1'
    };

    let allData = [];
    // currentSelection will let us filter by year or state (if applicable)
    let currentSelection = { yearRange: null, states: [] };

    // Global scales (will be defined later)
    let xScale, yScale, timeScale, prodScale;
    let scatterSVG, timelineSVG, mapSVG;

    // Load and process data from all sources concurrently
    Promise.all([
      d3.csv(DATA_URLS.crop),
      d3.csv(DATA_URLS.co2),
      d3.csv(DATA_URLS.temp)
    ]).then(([crop, co2, temp]) => {
      allData = mergeDatasets(crop, co2, temp);
      initializeVisualizations();
    }).catch(error => {
      console.error("Error loading data:", error);
    });

    // Merge datasets on year. For simplicity, we assume:
    // - Crop CSV has: TIME, Value, Country, and optionally a State field.
    // - CO2 CSV has: Year, total_emission, Country.
    // - Temp CSV has: year, temp.
    // We'll merge on year and add a dummy "state" (if not present, set to "USA").
    function mergeDatasets(crop, co2, temp) {
      const cropData = crop.filter(d => d.Country && (d.Country.includes("United States") || d.Country.includes("USA")))
                           .map(d => ({
                             year: +d.TIME,
                             production: +d.Value,
                             state: d.State || "USA"
                           }));
      const co2Data = co2.filter(d => d.Country && (d.Country.includes("United States") || d.Country.includes("USA")))
                         .map(d => ({
                           year: +d.Year,
                           co2: +d.total_emission
                         }));
      const tempData = temp.map(d => ({
        year: +d.year,
        temp: +d.temp
      }));
      // Include only years present in all three datasets.
      const years = [...new Set(cropData.map(d => d.year))]
                      .filter(y => co2Data.some(d => d.year === y) && tempData.some(d => d.year === y))
                      .sort((a, b) => a - b);
      const merged = years.map(year => {
        const c = cropData.find(d => d.year === year);
        const c2 = co2Data.find(d => d.year === year);
        const t = tempData.find(d => d.year === year);
        return {
          year: year,
          production: c.production,
          co2: c2.co2,
          temp: t.temp,
          state: c.state
        };
      });
      return merged;
    }

    function initializeVisualizations() {
      createScatterplot();
      createTimeline();
      createMap();
      addBrush();
    }

    // ---------------------
    // Scatterplot
    // ---------------------
    function createScatterplot() {
      const margin = { top: 20, right: 20, bottom: 40, left: 60 },
            width = 400 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;
      scatterSVG = d3.select("#scatterplot").append("svg")
                     .attr("width", width + margin.left + margin.right)
                     .attr("height", height + margin.top + margin.bottom)
                     .append("g")
                     .attr("transform", `translate(${margin.left},${margin.top})`);
      // Define scales for the scatterplot based on allData
      xScale = d3.scaleLinear()
                 .domain(d3.extent(allData, d => d.co2))
                 .range([0, width]);
      yScale = d3.scaleLinear()
                 .domain(d3.extent(allData, d => d.production))  // actual values, no division
                 .range([height, 0]);
      // Axes (set a fixed number of ticks to avoid repeated values)
      scatterSVG.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.format(".2f")));
      scatterSVG.append("g")
        .call(d3.axisLeft(yScale).ticks(5).tickFormat(d3.format(",")));
      // Draw data points
      scatterSVG.selectAll("circle")
        .data(allData)
        .enter().append("circle")
        .attr("cx", d => xScale(d.co2))
        .attr("cy", d => yScale(d.production))
        .attr("r", 4)
        .attr("fill", "#3498db")
        .on("mouseover", showTooltip)
        .on("mouseout", hideTooltip);
    }

    // ---------------------
    // Timeline
    // ---------------------
    function createTimeline() {
      const margin = { top: 20, right: 20, bottom: 40, left: 60 },
            width = 400 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;
      timelineSVG = d3.select("#timeline").append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", `translate(${margin.left},${margin.top})`);
      // Scales for timeline
      timeScale = d3.scaleLinear()
                    .domain(d3.extent(allData, d => d.year))
                    .range([0, width]);
      prodScale = d3.scaleLinear()
                    .domain(d3.extent(allData, d => d.production))
                    .range([height, 0]);
      // Axes
      timelineSVG.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(timeScale).ticks(5).tickFormat(d3.format("d")));
      timelineSVG.append("g")
        .call(d3.axisLeft(prodScale).ticks(5).tickFormat(d3.format(",")));
      // Line generator
      const line = d3.line()
                     .x(d => timeScale(d.year))
                     .y(d => prodScale(d.production));
      timelineSVG.append("path")
        .datum(allData)
        .attr("class", "trend-line")
        .attr("fill", "none")
        .attr("stroke", "#e74c3c")
        .attr("stroke-width", 2)
        .attr("d", line);
    }

    // ---------------------
    // Map
    // ---------------------
    function createMap() {
      const width = 400, height = 300;
      mapSVG = d3.select("#map").append("svg")
                 .attr("width", width)
                 .attr("height", height);
      // Draw US map using TopoJSON
      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
        const path = d3.geoPath();
        mapSVG.selectAll("path")
          .data(topojson.feature(us, us.objects.states).features)
          .enter().append("path")
          .attr("d", path)
          .attr("fill", "#ddd")
          .attr("stroke", "#fff")
          .on("click", (event, d) => {
            currentSelection.states = [d.properties.name];
            updateVisualizations();
          });
      });
    }

    // ---------------------
    // Brush on Timeline
    // ---------------------
    function addBrush() {
      const margin = { top: 20, right: 20, bottom: 40, left: 60 },
            width = 400 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;
      const brush = d3.brushX()
                      .extent([[0, 0], [width, height]])
                      .on("end", brushEnded);
      timelineSVG.append("g")
        .attr("class", "brush")
        .call(brush);
    }

    function brushEnded({ selection }) {
      if (!selection) {
        currentSelection.yearRange = null;
      } else {
        currentSelection.yearRange = [
          Math.round(timeScale.invert(selection[0])),
          Math.round(timeScale.invert(selection[1]))
        ];
      }
      updateVisualizations();
    }

    // ---------------------
    // Update Visualizations based on Selection
    // ---------------------
    function updateVisualizations() {
      const filtered = allData.filter(d => 
        (!currentSelection.yearRange || (d.year >= currentSelection.yearRange[0] && d.year <= currentSelection.yearRange[1])) &&
        (currentSelection.states.length === 0 || currentSelection.states.includes(d.state))
      );
      // Update scatterplot points color based on selection
      scatterSVG.selectAll("circle")
        .attr("fill", d => filtered.includes(d) ? "#e74c3c" : "#3498db");
      // Update timeline line
      const line = d3.line()
                     .x(d => timeScale(d.year))
                     .y(d => prodScale(d.production));
      timelineSVG.select(".trend-line")
        .datum(filtered)
        .attr("d", line);
    }

    // ---------------------
    // Tooltip
    // ---------------------
    function showTooltip(event, d) {
      d3.select("#tooltip")
        .style("opacity", 1)
        .html(`<strong>Year:</strong> ${d.year}<br>
               <strong>COâ‚‚:</strong> ${d.co2}<br>
               <strong>Production:</strong> ${d.production}<br>
               <strong>Temp:</strong> ${d.temp}`)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    }
    function hideTooltip() {
      d3.select("#tooltip").style("opacity", 0);
    }
  </script>
</body>
</html>
